!function(a,c,d,e){function f(a){var d,b=h.defaults,c={};for(d in b)b.hasOwnProperty(d)&&(c[d]=a.hasOwnProperty(d)?a[d]:b[d]);return c}function h(b){if(this.settings=f(b),!b.vertexShader)throw new Error('no "vertexShader" string setting defined');if(!b.fragmentShader)throw new Error('no "fragmentShader" string setting defined');if(!b.data)throw new Error('no "data" array setting defined');if(!b.map)throw new Error('no leaflet "map" object setting defined');var c=this.glLayer=d.canvasOverlay().drawing(function(a){this.drawOnCanvas(a)}.bind(this)).addTo(b.map),e=this.canvas=c.canvas();e.width=e.clientWidth,e.height=e.clientHeight,a.WebGLRenderingContext?(e=this.canvas=c.canvas(),this.gl=this.canvas.getContext("webgl",{antialias:!0})||e.getContext("experimental-webgl",{antialias:!0}),this.gl||(a.location="http://get.webgl.org/troubleshooting")):a.location="http://get.webgl.org",this.pixelsToWebGLMatrix=new Float32Array(16),this.mapMatrix=new Float32Array(16),this.vertexShader=null,this.fragmentShader=null,this.program=null,this.uMatrix=null,this.verts=null,this.latLngLookup=null,this.setup().render()}function j(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16)/255,g:parseInt(b[2],16)/255,b:parseInt(b[3],16)/255}:null}h.defaults={map:null,data:[],debug:!1,vertexShader:"",fragmentShader:"",pointThreshold:10,clickPoint:null,toggleLayer:null,color:[],baseLayers:[]},h.prototype={setup:function(){var a=this,b=this.settings;return b.toggleLayer&&b.map.on("viewreset",function(a){toggle?map.addLayer(glLayer):map.removeLayer(glLayer),toggle=!toggle}),b.clickPoint&&b.map.on("click",function(c){var d=a.lookup(c.latlng);null!==d&&b.clickPoint(d,c),b.debug&&a.debugPoint(c.containerPoint)}),this.setupVertexShader().setupFragmentShader().setupProgram()},render:function(){var a=$("<div id='lnlt'></div>").text('<button onclick="switchLayer()">Append text</button>');if($("lnlt").append(a),this.verts=[],this.latLngLookup={},this.settings.color.length<=7){if("#"!=this.settings.color[1].substring(0,1)){j(this.settings.color)}}else j(this.settings.color[this.settings.color.length-1]);this.settings.data.map(function(a,c){for(var d=[],c=2;c<a.length;c++)d[c-2]=a[c];var e=this.latLngToPixelXY(a[1],a[0],d.slice(3,d.length));r=d[0]/255,g=d[1]/255,b=d[2]/255,this.verts.push(e.x,e.y,r,g,b)}.bind(this));var d=this.gl,e=this.canvas,f=this.program,h=this.glLayer,i=this.uMatrix=d.getUniformLocation(f,"uMatrix"),k=d.getAttribLocation(f,"aColor"),l=d.getAttribLocation(f,"aVertex"),m=d.createBuffer(),n=new Float32Array(this.verts),o=n.BYTES_PER_ELEMENT;return d.aPointSize=d.getAttribLocation(f,"aPointSize"),this.pixelsToWebGLMatrix.set([2/e.width,0,0,0,0,-2/e.height,0,0,0,0,0,0,-1,1,0,1]),d.viewport(0,0,e.width,e.height),d.uniformMatrix4fv(i,!1,this.pixelsToWebGLMatrix),d.bindBuffer(d.ARRAY_BUFFER,m),d.bufferData(d.ARRAY_BUFFER,n,d.STATIC_DRAW),d.vertexAttribPointer(l,2,d.FLOAT,!1,5*o,0),d.enableVertexAttribArray(l),d.vertexAttribPointer(k,3,d.FLOAT,!1,5*o,2*o),d.enableVertexAttribArray(k),h.redraw(),this},setData:function(a){return this.settings.data=a,this},setupVertexShader:function(){var a=this.gl,b=a.createShader(a.VERTEX_SHADER);return a.shaderSource(b,this.settings.vertexShader),a.compileShader(b),this.vertexShader=b,this},setupFragmentShader:function(){var a=this.gl,b=a.createShader(a.FRAGMENT_SHADER);return a.shaderSource(b,this.settings.fragmentShader),a.compileShader(b),this.fragmentShader=b,this},setupProgram:function(){var a=this.gl,b=a.createProgram();return a.attachShader(b,this.vertexShader),a.attachShader(b,this.fragmentShader),a.linkProgram(b),a.useProgram(b),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA),a.enable(a.BLEND),this.program=b,this},drawOnCanvas:function(a){if(null==this.gl)return this;var b=this.gl,c=this.canvas,e=this.settings.map,f=e.getZoom(),g=e.getBounds(),h=new d.LatLng(g.getNorth(),g.getWest()),i=this.latLngToPixelXY(h.lat,h.lng),j=Math.pow(2,f),k=f/10*f;return b.clear(b.COLOR_BUFFER_BIT),this.pixelsToWebGLMatrix.set([2/c.width,0,0,0,0,-2/c.height,0,0,0,0,0,0,-1,1,0,1]),b.viewport(0,0,c.width,c.height),b.vertexAttrib1f(b.aPointSize,k),this.mapMatrix.set(this.pixelsToWebGLMatrix),this.scaleMatrix(j,j).translateMatrix(-i.x,-i.y),b.uniformMatrix4fv(this.uMatrix,!1,this.mapMatrix),b.drawArrays(b.POINTS,0,this.settings.data.length),this},latLngToPixelXY:function(a,b,c){var j,d=Math.PI/180,f=4*Math.PI,g=Math.sin(a*d),h=256*(.5-Math.log((1+g)/(1-g))/f),i=(b+180)/360*256,k=a.toFixed(5)+"x"+b.toFixed(5),l=this.latLngLookup[k];return j={lat:a,lng:b,a:c,x:i,y:h,key:k},l===e&&(l=this.latLngLookup[k]=[]),l.push(j),j},translateMatrix:function(a,b){var c=this.mapMatrix;return c[12]+=c[0]*a+c[4]*b,c[13]+=c[1]*a+c[5]*b,c[14]+=c[2]*a+c[6]*b,c[15]+=c[3]*a+c[7]*b,this},scaleMatrix:function(a,b){var c=this.mapMatrix;return c[0]*=a,c[1]*=a,c[2]*=a,c[3]*=a,c[4]*=b,c[5]*=b,c[6]*=b,c[7]*=b,this},addTo:function(a){return this.glLayer.addTo(a),this.layerControl.addOverlay(this.glLayer,"points"),this},lookup:function(a){for(var d,g,h,j,k,b=.001,c=a.lat-b,e=a.lat+b,f=a.lng+b,i=[];c<=e;c+=1e-5)for(d=a.lng-b;d<=f;d+=1e-5)if(k=c.toFixed(5)+"x"+d.toFixed(5),j=this.latLngLookup[k])for(g=0,h=j.length;g<h;g++)j[g].key=k,i.push(j[g]);return this.closestPoint(a,i)},closestPoint:function(a,b){function c(a,b){return Math.sqrt(a*a+b*b)}function d(a,b){return c(a.lat-b.lat,a.lng-b.lng)}return b.reduce(function(b,c){return d(a,b)<d(a,c)?b:c})},debugPoint:function(a){var b=c.createElement("div"),d=b.style,e=a.x,f=a.y;return d.left=e+"px",d.top=f+"px",d.width="100px",d.height="100px",d.position="absolute",d.backgroundColor="#"+(16777215*Math.random()<<0).toString(16),c.body.appendChild(b),this}},d.glify=function(a){return new d.Glify(a)},d.Glify=h}(window,document,L);
